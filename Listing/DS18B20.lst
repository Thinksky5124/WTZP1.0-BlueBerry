C51 COMPILER V9.00   DS18B20                                                               07/08/2018 13:33:01 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\Output\DS18B20.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Modules\DS18B20.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Li
                    -sting\DS18B20.lst) TABS(2) OBJECT(.\Output\DS18B20.obj)

line level    source

   1          /*****************************************************************
   2          **                   大连理工大学 创新创业学院
   3          **                       物联网应用工坊
   4          **---------------------------------------------------------------
   5          ** 项目名称：   WTZP1.0-BlueBerry
   6          ** 日    期：   2018-07-07
   7          ** 作    者：   温武军
   8          **---------------------------------------------------------------
   9          ** 文 件 名：   DS18B20.c
  10          ** 文件说明：   溶液温度测量
  11          *****************************************************************/
  12          
  13          /*---------------------INCLUDES----------------------*/
  14          #include "DS18B20.h"
  15          
  16          /*---------------------VARIABLES---------------------*/
  17          int16 LiquidT;
  18          uint8 a[2];
  19          
  20          /*---------------------FUNCTIONS---------------------*/
  21          /***********************************************************************
  22          ** 函 数 名： delayus(unsigned int b)
  23          ** 函数说明： 延时程序-延时1us
  24          **---------------------------------------------------------------------
  25          ** 输入参数： uint32
  26          ** 返回参数： 无
  27          ***********************************************************************/
  28          //该函数时间与晶振频率有关，此处为24Mhz
  29          void delayus(unsigned int b)
  30          {
  31   1         while (b--)
  32   1         {
  33   2             _nop_();_nop_();_nop_();_nop_();_nop_(); _nop_();_nop_();_nop_();_nop_();_nop_();
  34   2           _nop_();_nop_();_nop_();_nop_();_nop_(); _nop_();_nop_();_nop_();_nop_();_nop_();
  35   2           _nop_();_nop_();_nop_();_nop_();
  36   2         }
  37   1      }
  38          /***********************************************************************
  39          ** 函 数 名： DS18B20rest()
  40          ** 函数说明： 复位DS18B20
  41          **---------------------------------------------------------------------
  42          ** 输入参数： 无
  43          ** 返回参数： uint8
  44          ***********************************************************************/
  45          unsigned char DS18B20rest()
  46          {
  47   1        //unsigned char a;用于复位检测
  48   1        DQ=1;
  49   1        delayus(10);
  50   1        DQ=0;
  51   1        delayus(800);
  52   1        DQ=1;
  53   1        delayus(600);
  54   1        return 1;
C51 COMPILER V9.00   DS18B20                                                               07/08/2018 13:33:01 PAGE 2   

  55   1      }
  56          /***********************************************************************
  57          ** 函 数 名： write_byte()
  58          ** 函数说明： 写一个字节
  59          **---------------------------------------------------------------------
  60          ** 输入参数： uint8
  61          ** 返回参数： 无
  62          ***********************************************************************/
  63          void write_byte(unsigned char dat)
  64          {
  65   1        unsigned char i;
  66   1        unsigned char temp;
  67   1        for(i=0;i<8;i++)
  68   1        {
  69   2          temp=dat&0x01;
  70   2          DQ=0;
  71   2          delayus(15);
  72   2          DQ=dat&0x01;
  73   2          delayus(45);
  74   2          DQ=1;
  75   2          delayus(10);
  76   2          dat=dat>>1;
  77   2        }
  78   1        //delayus(100);
  79   1      }
  80          /***********************************************************************
  81          ** 函 数 名： read_byte()
  82          ** 函数说明： 读一个字节
  83          **---------------------------------------------------------------------
  84          ** 输入参数： 无
  85          ** 返回参数： uint8
  86          ***********************************************************************/
  87          unsigned char read_byte()
  88          {
  89   1        unsigned char i;
  90   1        unsigned char val;
  91   1        for(i=0;i<8;i++)
  92   1        {
  93   2          val>>=1;
  94   2          DQ=0; 
  95   2          delayus(2);
  96   2          DQ=1;
  97   2          delayus(4);
  98   2          if(DQ)
  99   2          {
 100   3            val=val|=0x80;
 101   3          }
 102   2          delayus(30);
 103   2        }
 104   1        return val;
 105   1      }
 106          /***********************************************************************
 107          ** 函 数 名： DS18B20Start()
 108          ** 函数说明： 启动DS18B20
 109          **---------------------------------------------------------------------
 110          ** 输入参数： 无
 111          ** 返回参数： uint8
 112          ***********************************************************************/
 113          unsigned char DS18B20Start()
 114          {
 115   1        unsigned char a;
 116   1        a=DS18B20rest();
C51 COMPILER V9.00   DS18B20                                                               07/08/2018 13:33:01 PAGE 3   

 117   1        if(a)
 118   1        {
 119   2          write_byte(0xcc);
 120   2          write_byte(0x44);
 121   2          return 1;
 122   2        }
 123   1        else 
 124   1          return 0;
 125   1      }
 126          /***********************************************************************
 127          ** 函 数 名： DS18B20()
 128          ** 函数说明： 再次启动DS18B20，并获得温度数据
 129          **---------------------------------------------------------------------
 130          ** 输入参数： 无
 131          ** 返回参数： int16(已转换好的温度)
 132          ***********************************************************************/
 133          int DS18B20()
 134          {
 135   1        //unsigned int TX,TZ;
 136   1        unsigned char b;
 137   1        float tt=0;
 138   1        b=DS18B20rest();
 139   1        if(b)
 140   1        {
 141   2          write_byte(0xcc);
 142   2          write_byte(0xbe);
 143   2          a[0]=read_byte();//低位
 144   2          a[1]=read_byte();//高位
 145   2          DQ=1;
 146   2        }
 147   1        LiquidT=a[1];
 148   1        LiquidT=LiquidT<<8;
 149   1        LiquidT=LiquidT|a[0];
 150   1        //TZ=(DS18B.a[0]>>4)|((DS18B.a[1]<<4)&0x3f);//温度整数部分
 151   1        //TX=DS18B.a[0]<<4;//温度小数部分
 152   1        tt=LiquidT*0.0625;
 153   1        LiquidT=tt*10+0.5;
 154   1        return LiquidT;
 155   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    290    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
