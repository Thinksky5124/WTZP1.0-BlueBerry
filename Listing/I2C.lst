C51 COMPILER V9.00   I2C                                                                   07/08/2018 13:33:01 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN .\Output\I2C.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Drivers\I2C.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listin
                    -g\I2C.lst) TABS(2) OBJECT(.\Output\I2C.obj)

line level    source

   1          /*****************************************************************
   2          **                   大连理工大学 创新创业学院
   3          **                       物联网应用工坊
   4          **---------------------------------------------------------------
   5          ** 项目名称：   WTZP1.0-BlueBerry
   6          ** 日    期：   2018-07-08
   7          ** 作    者：   温武军
   8          **---------------------------------------------------------------
   9          ** 文 件 名：   I2C.c
  10          ** 文件说明：   调用单片机内I2C通信模块（目前只有端口3）
  11          *****************************************************************/
  12          
  13          /*---------------------INCLUDES----------------------*/
  14          #include "I2C.h"
  15          
  16          /*---------------------VARIABLES---------------------*/
  17          
  18          
  19          /*---------------------FUNCTIONS---------------------*/
  20          void InitI2C()
  21          {
  22   1        P_SW2=P_SW2|0X30;
  23   1        I2CCFG = 0xe0;                              //使能I2C主机
  24   1         I2CMSST = 0x00;
  25   1      }
  26          
  27          void Wait()
  28          {
  29   1        while(!(I2CMSST&0x40));
  30   1        I2CMSST&=~0x40;
  31   1      }
  32          
  33          void Start()
  34          {
  35   1        I2CMSCR=0x01;
  36   1        Wait();
  37   1      }
  38          
  39          void SendData(unsigned char dat)
  40          {
  41   1        I2CTXD=dat;
  42   1        I2CMSCR=0x02;
  43   1        Wait();
  44   1      }
  45          
  46          void RecvACK()
  47          {
  48   1        I2CMSCR=0x03;
  49   1        Wait();
  50   1      }
  51          
  52          char RecvData()
  53          {
  54   1          I2CMSCR = 0x04;                             //发送RECV命令
C51 COMPILER V9.00   I2C                                                                   07/08/2018 13:33:01 PAGE 2   

  55   1          Wait();
  56   1          return I2CRXD;
  57   1      }
  58          
  59          void SendACK()
  60          {
  61   1          I2CMSST = 0x00;                             //设置ACK信号
  62   1          I2CMSCR = 0x05;                             //发送ACK命令
  63   1          Wait();
  64   1      }
  65          
  66          void SendNAK()
  67          {
  68   1          I2CMSST = 0x01;                             //设置NCK信号
  69   1          I2CMSCR = 0x05;                             //发送ACK信号
  70   1          Wait();
  71   1      }
  72          
  73          void Stop()
  74          {
  75   1          I2CMSCR = 0x06;                             //发送STOP命令
  76   1          Wait();
  77   1      }
  78          
  79          void Delay()
  80          {
  81   1          int i;
  82   1      
  83   1          for (i=0; i<3000; i++)
  84   1          {
  85   2              _nop_();
  86   2              _nop_();
  87   2              _nop_();
  88   2              _nop_();
  89   2          }
  90   1      }
  91          
  92          void I2C_AD5933()
  93          {
  94   1          Start();                                    //发送起始命令
  95   1          SendData(0xa0);                             //发送设备码加写命令
  96   1          RecvACK();
  97   1          SendData(0x00);                             //发送存储器地址高字节
  98   1          RecvACK();
  99   1          SendData(0x00);                             //发送存储器地址低字节
 100   1          RecvACK();
 101   1          SendData(0x12);                             //写数据
 102   1          RecvACK();
 103   1          Stop();                                     //发送停止命令
 104   1      
 105   1          Delay();                                    //等待设备写数据
 106   1      
 107   1          Start();                                    //发送起始命令
 108   1          SendData(0xa0);                             //
 109   1          RecvACK();
 110   1          SendData(0x00);                             //?????????
 111   1          RecvACK();
 112   1          SendData(0x00);                             //?????????
 113   1          RecvACK();
 114   1          Start();                                    //??????
 115   1          SendData(0xa1);                             //??????+???
 116   1          RecvACK();
C51 COMPILER V9.00   I2C                                                                   07/08/2018 13:33:01 PAGE 3   

 117   1          P0 = RecvData();                            //????1
 118   1          SendACK();
 119   1          P2 = RecvData();                            //????2
 120   1          SendNAK();
 121   1          Stop();                                     //??????
 122   1      
 123   1          P_SW2 = 0x00;
 124   1      
 125   1          while (1);
 126   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    211    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
